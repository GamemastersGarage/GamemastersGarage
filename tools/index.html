<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Text-Based Generators</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'League Spartan', sans-serif;
            background-color: #f8f1e7;
            color: #1a1a1a;
            margin: 20px;
        }
        .generator-block {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #ccc;
        }
        .sentence {
            font-size: 1.2em;
            line-height: 1.6;
        }
        .inline-button {
            display: inline-block;
            background: none;
            border: none;
            font: inherit;
            color: #007acc;
            text-decoration: underline;
            cursor: pointer;
            padding: 0 2px;
            margin: 0;
            white-space: normal;
            word-break: break-word;
        }
        .inline-button:hover {
            text-decoration: none;
        }
        button.reroll-all {
            margin-top: 10px;
            font-family: 'League Spartan', sans-serif;
            padding: 6px 12px;
            cursor: pointer;
        }
        a {
            color: #1a1a1a;
            text-decoration: underline;
        }
        a:hover {
            text-decoration: none;
        }
    </style>
</head>
<body>

<h1>Random Table Generators</h1>
<div id="generators"></div>

<script>
    const configs = [
        {
            title: "NPC Generator",
            description: "This is the NPC generator from *Quick NPCs Vol. 1*, available here:",
            csv: "npc.csv",
            template: (fields, ids) => 
                `<button class="inline-button" data-field="${ids[0]}"></button> has <button class="inline-button" data-field="${ids[1]}"></button> hair and <button class="inline-button" data-field="${ids[2]}"></button> skin.`,
            links: {
                etsy: "https://www.etsy.com/yourbook",
                dtrpg: "https://www.drivethrurpg.com/yourbook",
                itch: "https://yourname.itch.io/yourbook"
            }
        },
        {
            title: "Haunted House Generator",
            description: "This is the Haunted House generator from *Handbook of Hauntings*, available here:",
            csv: "haunted.csv",
            template: (fields, ids) => 
                `The house has <button class="inline-button" data-field="${ids[0]}"></button> and a <button class="inline-button" data-field="${ids[1]}"></button>, inhabited by <button class="inline-button" data-field="${ids[2]}"></button>.`,
            links: {
                etsy: "https://www.etsy.com/hauntbook",
                dtrpg: "https://www.drivethrurpg.com/hauntbook",
                itch: "https://yourname.itch.io/hauntbook"
            }
        }
    ];

    // Proper CSV parser to handle quotes and commas
    function parseCSV(text) {
        const rows = [];
        const lines = text.trim().split('\n');
        for (let line of lines) {
            const row = [];
            let val = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        val += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    row.push(val.trim());
                    val = '';
                } else {
                    val += char;
                }
            }
            row.push(val.trim());
            rows.push(row);
        }
        return rows;
    }

    function getNewRandom(arr, current) {
        if (arr.length <= 1) return arr[0] || '[No entry]';
        let newVal;
        do {
            newVal = arr[Math.floor(Math.random() * arr.length)];
        } while (newVal === current);
        return newVal;
    }

    function createGenerator(config, containerId) {
        fetch(config.csv)
            .then(res => res.text())
            .then(text => {
                const parsed = parseCSV(text);
                const headers = parsed[0];
                const records = parsed.slice(1);
                const data = {};

                headers.forEach((header, i) => {
                    data[header] = [];
                    records.forEach(row => {
                        if (row[i] && row[i].trim() !== '') {
                            data[header].push(row[i].trim());
                        }
                    });
                });

                const wrapper = document.createElement('div');
                wrapper.className = 'generator-block';

                const title = document.createElement('h2');
                title.textContent = config.title;
                wrapper.appendChild(title);

                const desc = document.createElement('p');
                desc.innerHTML = `${config.description} 
                    <a href="${config.links.etsy}" target="_blank">Etsy</a>, 
                    <a href="${config.links.dtrpg}" target="_blank">DriveThruRPG</a>, 
                    <a href="${config.links.itch}" target="_blank">Itch.io</a>`;
                wrapper.appendChild(desc);

                const sentencePara = document.createElement('p');
                sentencePara.className = 'sentence';
                const fieldIds = headers.map((_, i) => `${containerId}-${i}`);
                sentencePara.innerHTML = config.template(headers, fieldIds);
                wrapper.appendChild(sentencePara);

                headers.forEach((header, i) => {
                    const fieldId = fieldIds[i];
                    const btn = sentencePara.querySelector(`[data-field="${fieldId}"]`);
                    const reroll = () => {
                        const newVal = getNewRandom(data[header], btn.textContent);
                        btn.textContent = newVal;
                    };
                    btn.addEventListener('click', reroll);
                    reroll(); // Initial roll
                });

                const rerollAll = document.createElement('button');
                rerollAll.className = 'reroll-all';
                rerollAll.textContent = 'Reroll All';
                rerollAll.onclick = () => {
                    headers.forEach((header, i) => {
                        const fieldId = fieldIds[i];
                        const btn = sentencePara.querySelector(`[data-field="${fieldId}"]`);
                        btn.textContent = getNewRandom(data[header], btn.textContent);
                    });
                };
                wrapper.appendChild(rerollAll);

                document.getElementById('generators').appendChild(wrapper);
            });
    }

    configs.forEach((cfg, idx) => createGenerator(cfg, `gen${idx}`));
</script>
</body>
</html>
