<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../GamemastersGarage_Logo_Favicon_V01_48x48.svg" type="image/png">
  <title>Gamemaster's Garage</title>
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'League Spartan', sans-serif;
      background-color: #f8f0e3;
      color: #000;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    /* Burger Menu Styles */
    .menu-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      width: 30px;
      height: 25px;
      cursor: pointer;
      z-index: 2000;
    }

    .menu-toggle span {
      display: block;
      height: 4px;
      background: #000;
      margin: 5px 0;
      transition: 0.3s;
    }

    nav {
      position: fixed;
      top: 0;
      left: 0;
      background-color: #fbf6ef;
      width: 200px;
      height: 100vh;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 1500;
      padding-top: 60px;
      text-align: left;
    }

    nav.active {
      transform: translateX(0);
    }

    nav ul {
      list-style: none;
      padding: 0 20px;
    }

    nav li {
      margin: 20px 0;
    }

    nav a {
      color: #000;
      text-decoration: none;
      font-size: 18px;
    }

    header {
      padding: 60px 20px 40px;
    }

    header img {
      max-width: 150px;
    }

    h1 {
      font-size: 2em;
      margin: 20px 0;
    }

    .signup {
      margin: 20px 0;
    }

    .form-button {
      padding: 12px 24px;
      font-size: 18px;
      font-family: 'League Spartan', sans-serif;
      background-color: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    .form-button:hover {
      background-color: #333;
    }

    /* Original app styles */
    .controls { margin-bottom: 20px; }
    canvas { border: 1px solid #333; margin-top: 20px; display: block; margin-left: auto; margin-right: auto; }
    .miniature-input { margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; background-color: #fff; display: inline-block; text-align: left; }
    .miniature-input select, .miniature-input input { margin-right: 10px; }
    button { margin-right: 10px; margin-top: 10px; }

    @media print {
      body * { visibility: hidden; }
      #pages canvas {
        visibility: visible;
        position: relative;
        width: 210mm;
        height: 297mm;
        border: none !important;
        page-break-after: always;
      }
      @page { size: A4 portrait; margin: 0; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <div class="menu-toggle" onclick="document.querySelector('nav').classList.toggle('active')">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <nav>
    <ul>
     <li><a href="../">Manuals</a></li>
      <li><a href="/tools/">Tools</a></li>
      <li><a href="/mini-layout-generator/">Paper Minis Tool</a></li>
      <li><a href="https://buymeacoffee.com/gamemastersgarage" target="_blank" rel="noopener noreferrer">Buy me a coffee</a></li>
    </ul>
  </nav>

  <header>
    <picture>
      <source srcset="../GamemastersGarage_Logo_WEBP_512x.webp" type="image/webp">
      <img src="../GamemastersGarage_Logo_PNG_512x.png" alt="Gamemaster's Garage Logo" width="150" />
    </picture>
    <h1>Paper Miniatures Generator</h1>
  </header>

  <div id="controls"></div>
  <button class="form-button" onclick="addMiniatureInput()">‚ûï Add Miniature</button>
  <button class="form-button" onclick="window.print()">üñ®Ô∏è Print Pages</button>
  <button class="form-button" onclick="saveAsPDF()">üíæ Save as PDF</button>

  <div id="pages"></div>

<script>
// --- OPTION DEFINITIONS ---
const bodyOptions   = ['Dwarf','Orc','Ogre','Human','Skeleton','Elf','Bug','Robot','Cat','Lizard','Devil'];
const colourOptions = ['Red','Green','Blue','Yellow','Black','White','Brown','Gray','Orange','Purple','Pink','Silver','Peach','PaleGreen'];
const sizeOptions   = ['Short wide','Short','Short thin','Medium wide','Medium','Medium thin','Tall wide','Tall','Tall thin'];
const clothesOptions= ['None','Plate Armour','Leather Armour','Tunic','Robe','Power Armour','Rags','Suit','Finery'];
const legsOptions   = ['None','Spider','Snake','Centaur'];
const weaponOptions = ['None','Longsword','Axe','Hammer'];

// Default Colour & Size per Body
const bodyDefaults = {
  Dwarf:   { colour:'Brown',    size:'Short'       },
  Orc:     { colour:'Green',    size:'Tall'        },
  Ogre:    { colour:'Gray',     size:'Tall wide'   },
  Human:   { colour:'Peach',    size:'Medium'      },
  Skeleton:{ colour:'White',    size:'Medium thin' },
  Elf:     { colour:'PaleGreen',size:'Medium'      },
  Bug:     { colour:'Orange',   size:'Short wide'  },
  Robot:   { colour:'Silver',   size:'Medium'      },
  Cat:     { colour:'Orange',   size:'Short thin'  },
  Lizard:  { colour:'Green',    size:'Short'       },
  Devil:   { colour:'Red',      size:'Medium'      }
};

// Size ‚Üí width/height multipliers
const sizeScales = {
  'Short wide':  {w:1.0, h:0.8},
  'Short':       {w:0.8, h:0.8},
  'Short thin':  {w:0.6, h:0.8},
  'Medium wide': {w:1.2, h:1.0},
  'Medium':      {w:1.0, h:1.0},
  'Medium thin': {w:0.8, h:1.0},
  'Tall wide':   {w:1.4, h:1.2},
  'Tall':        {w:1.2, h:1.2},
  'Tall thin':   {w:1.0, h:1.2},
};

// --- UTILITY TO LOAD AN IMAGE ---
function loadImage(src) {
  return new Promise(resolve => {
    const img = new Image();
    img.src = src;
    img.onload  = () => resolve(img);
    img.onerror = () => { console.warn(`Failed to load ${src}`); resolve(null); };
  });
}

// --- ADD ONE MINIATURE CONTROLS ROW ---
function addMiniatureInput() {
  const div = document.createElement('div');
  div.className = 'miniature-input';
  div.innerHTML = `
    Body:   <select class="body">${bodyOptions.map(o=>`<option>${o}</option>`).join('')}</select>
    Colour: <select class="colour">${colourOptions.map(o=>`<option>${o}</option>`).join('')}</select>
    Size:   <select class="size">${sizeOptions.map(o=>`<option>${o}</option>`).join('')}</select><br>
    Clothes:<select class="clothes">${clothesOptions.map(o=>`<option>${o}</option>`).join('')}</select>
    Legs:   <select class="legs">${legsOptions.map(o=>`<option>${o}</option>`).join('')}</select><br>
    Hand-1: <select class="hand1">${weaponOptions.map(o=>`<option>${o}</option>`).join('')}</select>
    Hand-2: <select class="hand2">${weaponOptions.map(o=>`<option>${o}</option>`).join('')}</select>
    Qty:    <input type="number" class="quantity" value="1" min="1">
    <button onclick="this.parentNode.remove(); generate();">‚ùå Delete</button>
  `;
  document.getElementById('controls').appendChild(div);

  // Attach change listeners to regenerate on any change; update defaults on Body change
  div.querySelectorAll('select, input').forEach(el => {
    el.addEventListener('change', () => {
      if (el.classList.contains('body')) applyDefaults(div);
      generate();
    });
  });

  // Initial defaults & first draw
  applyDefaults(div);
  generate();
}

// Apply default Colour & Size when Body changes
function applyDefaults(div) {
  const b = div.querySelector('.body').value;
  const def = bodyDefaults[b];
  div.querySelector('.colour').value = def.colour;
  div.querySelector('.size').value   = def.size;
}

// --- MAIN GENERATION ROUTINE ---
async function generate() {
  const pagesDiv = document.getElementById('pages');
  pagesDiv.innerHTML = '';
  const tabH = 70, margin = 118,
        pageW = 2480, pageH = 3508,
        baseW = 400, baseH = 512;

  // Gather every miniature request
  const miniatures = [];
  document.querySelectorAll('.miniature-input').forEach(div => {
    const body   = div.querySelector('.body').value;
    const colour = div.querySelector('.colour').value;
    const size   = div.querySelector('.size').value;
    const clothes= div.querySelector('.clothes').value;
    const legs   = div.querySelector('.legs').value;
    const hand1  = div.querySelector('.hand1').value;
    const hand2  = div.querySelector('.hand2').value;
    const qty    = parseInt(div.querySelector('.quantity').value) || 1;
    for (let i=0; i<qty; i++) {
      miniatures.push({body,colour,size,clothes,legs,hand1,hand2});
    }
  });

  let pageNum = 1, {canvas, ctx} = createNewPage(pageNum);
  let x = margin, y = margin, rowH = 0;

  for (const m of miniatures) {
    const scale = sizeScales[m.size] || {w:1,h:1};
    const w = baseW * scale.w, h = baseH * scale.h;

    // Build each figure on an offscreen canvas
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext('2d');

    // 1) Body (tinted)
    const bodyImg = await loadImage(`images/body/body_${m.body}.png`);
    if (bodyImg) {
      tctx.drawImage(bodyImg,0,0,w,h);
      tctx.globalCompositeOperation = 'source-in';
      tctx.fillStyle = m.colour;
      tctx.fillRect(0,0,w,h);
      tctx.globalCompositeOperation = 'source-over';
    }

    // 2) Hand-1 (under everything, slight offset)
    if (m.hand1!=='None') {
      const h1 = await loadImage(`images/weapon/weapon_${m.hand1}.png`);
      if (h1) tctx.drawImage(h1, w*0.05, h*0.05, w, h);
    }

    // 3) Clothes
    if (m.clothes!=='None') {
      const c = await loadImage(
        `images/clothes/clothes_${m.clothes}.png`
      );
      if (c) tctx.drawImage(c,0,0,w,h);
    }

    // 4) Legs (on top of clothes)
    if (m.legs!=='None') {
      const lg = await loadImage(`images/legs/legs_${m.legs}.png`);
      if (lg) tctx.drawImage(lg,0,0,w,h);
    }

    // 5) Hand-2 (on very top)
    if (m.hand2!=='None') {
      const h2 = await loadImage(`images/weapon/weapon_${m.hand2}.png`);
      if (h2) tctx.drawImage(h2,0,0,w,h);
    }

    // Page‚Äêlayout logic
    if (x + w > pageW - margin) {
      x = margin; y += rowH + tabH*2; rowH = 0;
    }
    if (y + (h*2 + tabH*2) > pageH - margin) {
      pageNum++;
      ({canvas, ctx} = createNewPage(pageNum));
      x = margin; y = margin; rowH = 0;
    }

    // Draw mirror + upright with tabs exactly as before
    ctx.save();
      ctx.translate(x + w/2, y + h/2);
      ctx.scale(1, -1);
      ctx.drawImage(tmp, -w/2, -h/2, w, h);
    ctx.restore();
    ctx.drawImage(tmp, x, y + h, w, h);

    // Dashed fold line
    ctx.save();
      ctx.setLineDash([5,5]);
      ctx.strokeStyle = 'rgba(0,0,0,0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x, y + h);
      ctx.lineTo(x + w, y + h);
      ctx.stroke();
    ctx.restore();

    // Tabs top & bottom
    ctx.save();
      ctx.setLineDash([5,5]);
      ctx.strokeStyle = 'rgba(0,0,0,0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath();
        ctx.moveTo(x, y - tabH);
        ctx.lineTo(x + w, y - tabH);
        ctx.lineTo(x + w, y);
        ctx.lineTo(x, y);
        ctx.closePath();
        ctx.stroke();
      ctx.beginPath();
        ctx.moveTo(x, y + h*2);
        ctx.lineTo(x + w, y + h*2);
        ctx.lineTo(x + w, y + h*2 + tabH);
        ctx.lineTo(x, y + h*2 + tabH);
        ctx.closePath();
        ctx.stroke();
    ctx.restore();

    // Border around each
    ctx.save();
      ctx.setLineDash([10,5]);
      ctx.strokeStyle = 'rgba(128,128,128,0.1)';
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, w, h*2);
    ctx.restore();

    x += w;
    rowH = Math.max(rowH, h*2 + tabH*2);
  }
}

// Create a new A4 page canvas
function createNewPage(pageNum) {
  const canvas = document.createElement('canvas');
  canvas.width = 2480; canvas.height = 3508;
  canvas.style.pageBreakAfter = "always";
  document.getElementById('pages').appendChild(canvas);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'white';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font = "30px sans-serif";
  ctx.fillStyle = "rgba(0,0,0,0.3)";
  ctx.fillText(`Page ${pageNum}`, 100, 100);
  return {canvas, ctx};
}

// Export all pages to PDF
async function saveAsPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
  const canvases = document.querySelectorAll('#pages canvas');
  for (let i=0; i<canvases.length; i++) {
    const img = canvases[i].toDataURL('image/jpeg',1.0);
    if (i>0) pdf.addPage();
    pdf.addImage(img, 'JPEG', 0,0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
  }
  pdf.save('miniatures.pdf');
}
</script>
</body>
</html>
