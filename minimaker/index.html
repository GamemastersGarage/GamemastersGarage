<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../GamemastersGarage_Logo_Favicon_V01_48x48.svg" type="image/png">
  <title>Gamemaster's Garage</title>
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan&display=swap" rel="stylesheet" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'League Spartan', sans-serif;
      background-color: #f8f0e3;
      color: #000;
      overflow: hidden;
      display: flex;
    }

    /* NAV */
    nav {
      position: fixed;
      top: 0; left: 0;
      width: 350px; height: 100vh;
      background-color: #fbf6ef;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding-top: 60px;
      text-align: left;
      z-index: 1500;
    }
    nav.active { transform: translateX(0); }
    nav ul { list-style: none; padding: 0 20px; }
    nav li { margin: 20px 0; }
    nav a { color: #000; text-decoration: none; font-size: 18px; }

    /* MAIN SPLIT */
    #main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* CONTROLS */
    #controls {
      width: 350px;
      background-color: #fbf6ef;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #control-box {
      flex: 0 0 auto;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    /* burger menu now inside control-box */
    .menu-toggle {
      position: relative;      /* enable z-index */
      z-index: 2000;           /* sit above nav (which is 1500) */
      display: block;
      width: 30px; height: 25px;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .menu-toggle span {
      display: block;
      height: 4px;
      background: #000;
      margin: 5px 0;
      transition: 0.3s;
    }
    #control-box img {
      width: 100px;
      display: block;
      margin: 0 auto 10px;
    }
    #control-box .instructions {
      font-size: 14px;
      margin-bottom: 15px;
      line-height: 1.4;
      text-align: center;
    }
    #control-box .form-button {
      display: block;
      width: 100%;
      padding: 10px 0;
      margin-bottom: 8px;
      font-size: 16px;
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #control-box .form-button:hover {
      background-color: #333;
    }
    #miniature-inputs {
      width: 300px;              /* fixed sidebar width‚Äîtweak as you like */
      height: 100vh;             /* span the full viewport height */
      box-sizing: border-box;    /* include that padding */
      background-color: #fbf6ef; /* match the controls pane */
      overflow-y: auto;          /* keep scrolling enabled */
      padding: 10px 20px;
      border-right: 1px solid #ccc; /* separates it from the preview */
    }

    /* PREVIEW */
    #pages {
      flex: 1;
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #pages canvas {
      max-height: 100%;
      width: auto;
      margin: 10px 0;
      border: 1px solid #333;
    }

    /* MINIATURE INPUTS */
    .miniature-input {
      margin-bottom: 12px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #fff;
      text-align: left;
      width: 100%;
    }
    .miniature-input select,
    .miniature-input input {
      margin-right: 8px;
    }
    .miniature-input button {
      margin-top: 8px;
    }

    /* PRINT STYLES */
    @media print {
      body * { visibility: hidden; }
      #pages, #pages canvas { visibility: visible !important; }
      #pages {
        overflow: visible !important;
        position: static !important;
        height: auto !important;
      }
      #pages canvas {
        position: relative !important;
        width: 210mm !important;
        height: 297mm !important;
        border: none !important;
        page-break-after: always !important;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="main">
    <div id="controls">
      <div id="control-box">
        <div class="menu-toggle" onclick="document.querySelector('nav').classList.toggle('active')">
          <span></span><span></span><span></span>
        </div>
        <picture>
          <source srcset="../GamemastersGarage_Logo_WEBP_512x.webp" type="image/webp">
          <img src="../GamemastersGarage_Logo_PNG_512x.png" alt="Logo">
        </picture>
        <div class="instructions">
          Select or add your miniatures below.<br>
          Changes appear in the preview pane in real time.
        </div>
        <button class="form-button" onclick="addMiniatureInput()">‚ûï Add Miniature</button>
        <button class="form-button" onclick="printViaPDF()">üñ®Ô∏è Print Pages</button>
        <button class="form-button" onclick="saveAsPDF()">üíæ Save as PDF</button>
      </div>
    </div>
          <div id="miniature-inputs"></div>
    <div id="pages"></div>
  </div>

  <nav>
    <ul>
      <li><a href="../">Manuals</a></li>
      <li><a href="/tools/">Tools</a></li>
      <li><a href="/mini-layout-generator/">Paper Minis Tool</a></li>
      <li><a href="https://buymeacoffee.com/gamemastersgarage" target="_blank" rel="noopener noreferrer">Buy me a coffee</a></li>
    </ul>
  </nav>

  <script>
    const bodyOptions   = ['Dwarf','Orc','Ogre','Human','Skeleton','Elf','Bug','Robot','Cat','Lizard','Devil'];
    const colourOptions = ['Red','Green','Blue','Yellow','Black','White','Brown','Gray','Orange','Purple','Pink','Silver','Peach','PaleGreen'];
    const sizeOptions   = ['Short wide','Short','Short thin','Medium wide','Medium','Medium thin','Tall wide','Tall','Tall thin'];
    const clothesOptions= ['None','Plate Armour','Leather Armour','Tunic','Robe','Power Armour','Rags','Suit','Finery'];
    const legsOptions   = ['None','Spider','Snake','Centaur'];
    const weaponOptions = ['None','Longsword','Axe','Hammer'];

    const bodyDefaults = {
      Dwarf:   { colour:'Brown',    size:'Short'       },
      Orc:     { colour:'Green',    size:'Tall'        },
      Ogre:    { colour:'Gray',     size:'Tall wide'   },
      Human:   { colour:'Peach',    size:'Medium'      },
      Skeleton:{ colour:'White',    size:'Medium thin' },
      Elf:     { colour:'PaleGreen',size:'Medium'      },
      Bug:     { colour:'Orange',   size:'Short wide'  },
      Robot:   { colour:'Silver',   size:'Medium'      },
      Cat:     { colour:'Orange',   size:'Short thin'  },
      Lizard:  { colour:'Green',    size:'Short'       },
      Devil:   { colour:'Red',      size:'Medium'      }
    };

    const sizeScales = {
      'Short wide':  {w:1.0, h:0.8},
      'Short':       {w:0.8, h:0.8},
      'Short thin':  {w:0.6, h:0.8},
      'Medium wide': {w:1.2, h:1.0},
      'Medium':      {w:1.0, h:1.0},
      'Medium thin': {w:0.8, h:1.0},
      'Tall wide':   {w:1.4, h:1.2},
      'Tall':        {w:1.2, h:1.2},
      'Tall thin':   {w:1.0, h:1.2},
    };

    function loadImage(src) {
      return new Promise(resolve => {
        const img = new Image();
        img.src = src;
        img.onload  = () => resolve(img);
        img.onerror = () => { console.warn(`Failed to load ${src}`); resolve(null); };
      });
    }

    function addMiniatureInput() {
      const div = document.createElement('div');
      div.className = 'miniature-input';
      div.innerHTML = `
        Body:   <select class="body">${bodyOptions.map(o=>`<option>${o}</option>`).join('')}</select>
        Colour: <select class="colour">${colourOptions.map(o=>`<option>${o}</option>`).join('')}</select>
        Size:   <select class="size">${sizeOptions.map(o=>`<option>${o}</option>`).join('')}</select><br>
        Clothes:<select class="clothes">${clothesOptions.map(o=>`<option>${o}</option>`).join('')}</select>
        Legs:   <select class="legs">${legsOptions.map(o=>`<option>${o}</option>`).join('')}</select><br>
        Hand-1: <select class="hand1">${weaponOptions.map(o=>`<option>${o}</option>`).join('')}</select>
        Hand-2: <select class="hand2">${weaponOptions.map(o=>`<option>${o}</option>`).join('')}</select>
        Qty:    <input type="number" class="quantity" value="1" min="1" max="10">
        <button onclick="this.parentNode.remove(); generate();">‚ùå Delete</button>
      `;
      document.getElementById('miniature-inputs').appendChild(div);
      div.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', () => {
          if (el.classList.contains('body')) applyDefaults(div);
          if (el.classList.contains('quantity')) {
            let v = parseInt(el.value, 10)||1;
            if (v>10) v=10; if (v<1) v=1;
            el.value = v;
          }
          generate();
        });
      });
      applyDefaults(div);
      generate();
    }

    function applyDefaults(div) {
      const def = bodyDefaults[div.querySelector('.body').value];
      div.querySelector('.colour').value = def.colour;
      div.querySelector('.size').value   = def.size;
    }

    async function generate() {
      const pagesDiv = document.getElementById('pages');
      pagesDiv.innerHTML = '';
      const tabH = 140, margin = 25 + tabH,
            pageW = 2480, pageH = 3508,
            baseW = 400, baseH = 512;
      const miniatures = [];
      document.querySelectorAll('.miniature-input').forEach(div => {
        const body   = div.querySelector('.body').value;
        const colour = div.querySelector('.colour').value;
        const size   = div.querySelector('.size').value;
        const clothes= div.querySelector('.clothes').value;
        const legs   = div.querySelector('.legs').value;
        const hand1  = div.querySelector('.hand1').value;
        const hand2  = div.querySelector('.hand2').value;
        const qty    = parseInt(div.querySelector('.quantity').value)||1;
        for (let i=0; i<qty; i++) miniatures.push({body,colour,size,clothes,legs,hand1,hand2});
      });

      let pageNum = 1, {canvas, ctx} = createNewPage(pageNum);
      let x = margin, y = margin, rowH = 0;

      for (const m of miniatures) {
        const scale = sizeScales[m.size] || {w:1,h:1};
        const w = baseW*scale.w, h = baseH*scale.h;
        const tmp = document.createElement('canvas');
        tmp.width = w; tmp.height = h;
        const tctx = tmp.getContext('2d');

        const bodyImg = await loadImage(`images/body/body_${m.body}.png`);
        if (bodyImg) {
          tctx.fillStyle = m.colour;
          tctx.fillRect(0,0,w,h);
          tctx.globalCompositeOperation = 'destination-in';
          tctx.drawImage(bodyImg,0,0,w,h);
          tctx.globalCompositeOperation = 'multiply';
          tctx.drawImage(bodyImg,0,0,w,h);
          tctx.globalCompositeOperation = 'source-over';
        }

        if (m.hand1!=='None') {
          const h1 = await loadImage(`images/weapon/weapon_${m.hand1}.png`);
          if (h1) tctx.drawImage(h1,w*0.05,h*0.05,w,h);
        }
        if (m.clothes!=='None') {
          const c = await loadImage(`images/clothes/clothes_${m.clothes}.png`);
          if (c) tctx.drawImage(c,0,0,w,h);
        }
        if (m.legs!=='None') {
          const lg = await loadImage(`images/legs/legs_${m.legs}.png`);
          if (lg) tctx.drawImage(lg,0,0,w,h);
        }
        if (m.hand2!=='None') {
          const h2 = await loadImage(`images/weapon/weapon_${m.hand2}.png`);
          if (h2) tctx.drawImage(h2,0,0,w,h);
        }

        if (x + w > pageW - margin) {
          x = margin; y += rowH + tabH*2; rowH = 0;
        }
        if (y + (h*2 + tabH*2) > pageH - margin) {
          pageNum++;
          ({canvas, ctx} = createNewPage(pageNum));
          x = margin; y = margin; rowH = 0;
        }

        ctx.save();
          ctx.translate(x + w/2, y + h/2);
          ctx.scale(1, -1);
          ctx.drawImage(tmp, -w/2, -h/2, w, h);
        ctx.restore();
        ctx.drawImage(tmp, x, y + h, w, h);

        ctx.save();
          ctx.setLineDash([5,5]);
          ctx.strokeStyle = 'rgba(0,0,0,0.2)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, y + h);
          ctx.lineTo(x + w, y + h);
          ctx.stroke();
        ctx.restore();

        ctx.save();
          ctx.setLineDash([5,5]);
          ctx.strokeStyle = 'rgba(0,0,0,0.2)';
          ctx.lineWidth = 1;
          ctx.beginPath();
            ctx.moveTo(x, y - tabH);
            ctx.lineTo(x + w, y - tabH);
            ctx.lineTo(x + w, y);
            ctx.lineTo(x, y);
            ctx.closePath();
            ctx.stroke();
          ctx.beginPath();
            ctx.moveTo(x, y + h*2);
            ctx.lineTo(x + w, y + h*2);
            ctx.lineTo(x + w, y + h*2 + tabH);
            ctx.lineTo(x, y + h*2 + tabH);
            ctx.closePath();
            ctx.stroke();
        ctx.restore();

        ctx.save();
          ctx.setLineDash([10,5]);
          ctx.strokeStyle = 'rgba(128,128,128,0.1)';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, w, h*2);
        ctx.restore();

        x += w;
        rowH = Math.max(rowH, h*2);
      }
    }

    function createNewPage(pageNum) {
      const canvas = document.createElement('canvas');
      canvas.width = 2480; canvas.height = 3508;
      canvas.style.pageBreakAfter = "always";
      document.getElementById('pages').appendChild(canvas);
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      return {canvas, ctx};
    }

    async function saveAsPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
      const canvases = document.querySelectorAll('#pages canvas');
      for (let i=0; i<canvases.length; i++) {
        const img = canvases[i].toDataURL('image/jpeg',1.0);
        if (i>0) pdf.addPage();
        pdf.addImage(img, 'JPEG', 0,0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
      }
      pdf.save('miniatures.pdf');
    }
function printViaPDF() {
  const { jsPDF } = window.jspdf;
  // 1) Build the PDF exactly as you do in saveAsPDF()
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
  const canvases = document.querySelectorAll('#pages canvas');
  canvases.forEach((canvas, idx) => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    if (idx > 0) pdf.addPage();
    pdf.addImage(
      imgData,
      'JPEG',
      0,
      0,
      pdf.internal.pageSize.getWidth(),
      pdf.internal.pageSize.getHeight()
    );
  });

  // 2) Embed and auto-print
  pdf.autoPrint();                                      // instruct PDF to pop its print dialog
  const blob = pdf.output('blob');                      // get a Blob
  const url  = URL.createObjectURL(blob);               // turn it into an object URL
  const iframe = document.createElement('iframe');      // hidden print frame
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);

iframe.onload = () => {
  setTimeout(() => {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(iframe);
    }, 2000); // cleanup
  }, 500); // delay before print() ‚Äì tweak if needed
};
}
  </script>
</body>
</html>
